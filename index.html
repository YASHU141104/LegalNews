<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LegalNewsIndia - Law News</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      background: #f4f7fa;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 2em 10vw;
      transition: background 0.4s, color 0.4s;
    }
    body.dark-mode {
      background: #181a1b;
      color: #e7e7e7;
    }
    .logo-area {
      display: flex;
      align-items: center;
      margin-bottom: 1em;
      gap: 0.7em;
    }
    .logo {
      font-size: 2.3em;
      border-radius: 50%;
      background: #244e86;
      color: #fff;
      width: 2em;
      height: 2em;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .sitename {
      font-size: 1.7em;
      font-weight: 700;
      color: #244e86;
    }
    .dark-mode .sitename { color: #ffca28; }
    .dark-toggle-btn {
      margin-left: auto;
      background: #244e86;
      color: #fff;
      border: none;
      padding: 0.4em 1em;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1em;
      transition: background 0.2s;
    }
    .dark-mode .dark-toggle-btn { background: #ffca28; color: #111; }

    .top-story-highlight {
      background: linear-gradient(90deg, #244e86 60%, #ffca28 100%);
      border-radius: 1.5em;
      box-shadow: 0 6px 28px #00336645;
      color: #fff;
      padding: 2.2em 2.2em 2em 2.2em;
      margin-bottom: 2em;
      position: relative;
      display: flex;
      align-items: center;
      gap: 2.5em;
      min-height: 200px;
    }
    .top-story-ribbon {
      position: absolute;
      top: 1em; left: 2em;
      background: #b30348;
      color: #fff;
      padding: 0.5em 1.4em;
      border-radius: 1em;
      font-weight: bold;
      font-size: 1.08em;
      letter-spacing: 1px;
      z-index: 2;
      box-shadow: 0 1px 7px #fff5;
    }
    .top-story-featured-badge {
      position: absolute;
      top: 3.4em; left: 2em;
      background: #22c55e;
      color: #fff;
      padding: 0.35em 1.2em;
      border-radius: 1em;
      font-weight: bold;
      font-size: 0.98em;
      z-index: 2;
      box-shadow: 0 1px 7px #fff5;
    }
    .top-story-img {
      width: 180px;
      height: 180px;
      min-width:180px;
      min-height:180px;
      border-radius: 1em;
      object-fit: cover;
      box-shadow: 0 4px 24px #2228;
      background: #f0efea;
      margin-right: 1em;
      display: block;
    }
    .top-story-placeholder {
      width: 180px;
      height: 180px;
      min-width:180px;
      min-height:180px;
      border-radius: 1em;
      background: linear-gradient(135deg, #ffe082, #b3c6e6 80%);
      color: #244e86;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.13em;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 24px #2228;
      margin-right: 1em;
    }
    .top-story-content {
      flex: 1;
      min-width: 0;
    }
    .top-story-title {
      font-size: 2.2em;
      line-height: 1.1;
      font-weight: 800;
      color: #ffe082;
      margin: 0 0 0.18em 0;
      text-shadow: 1px 3px 4px #2226;
    }
    .top-story-meta {
      font-size: 1em;
      font-weight: 600;
      color: #fffde4;
      margin-bottom: 0.7em;
    }
    .top-story-snippet {
      font-size: 1.21em;
      color: #fff;
      margin-bottom: 0.95em;
      margin-top: 0.15em;
    }
    .top-story-link {
      display: inline-block;
      font-size: 1.09em;
      background: #fffde4;
      color: #244e86;
      border-radius: 0.8em;
      font-weight: bold;
      padding: 0.6em 1.6em;
      box-shadow: 0 1px 6px #eee;
      text-decoration: none;
      margin-top: 0.8em;
      transition: background 0.2s, color 0.2s;
    }
    .top-story-link:hover { background: #ffe082; color: #a90025;}
    .top-story-arrow {
      background: #fffde4;
      color: #244e86;
      border: none;
      border-radius: 50%;
      font-size: 2.2em;
      width: 48px; height: 48px;
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      font-weight: bold;
      box-shadow: 0 2px 9px #2224;
      cursor: pointer;
      z-index:5;
      transition: background 0.18s;
    }
    .top-story-arrow:active { background:#ffe082; }
    .top-story-arrow.left { left:-38px; }
    .top-story-arrow.right { right:-38px; }
    @media (max-width: 900px) {
      .top-story-highlight { flex-direction:column; gap:1.5em; overflow:auto; padding:1.1em;}
      .top-story-arrow.left{ left:0;}
      .top-story-arrow.right{ right:0;}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="logo-area">
    <span class="logo">⚖️</span>
    <span class="sitename">LegalNewsIndia</span>
    <button class="dark-toggle-btn" id="darkToggleBtn" title="Toggle dark mode">Dark Mode</button>
  </div>
  <div id="top-carousel"></div>
  <div id="statusMsg"></div>
  <input type="text" id="searchBar" placeholder="Search news by keywords or date (YYYY-MM-DD)..." autocomplete="off" />
  <div id="law-news">Loading news...</div>
  <script>
    // Dark mode toggle
    const darkBtn = document.getElementById("darkToggleBtn");
    function setDarkMode(state) {
      document.body.classList.toggle("dark-mode", state);
      localStorage.setItem("dark-mode", state ? "1" : "");
      darkBtn.textContent = state ? "Light Mode" : "Dark Mode";
    }
    darkBtn.onclick = () => setDarkMode(!document.body.classList.contains("dark-mode"));
    (()=>{ if(localStorage.getItem("dark-mode")) setDarkMode(true); })();

    const supabase_url = "https://xddssiompemprjbnxxlf.supabase.co";
    const supabase_key = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkZHNzaW9tcGVtcHJqYm54eGxmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMDczNzcsImV4cCI6MjA3Mzc4MzM3N30.QHjF8xdFYp6ex1YW2XV6GkKvPZXNp1biImoQIZdSMG4";
    const supabase = window.supabase.createClient(supabase_url, supabase_key);
    const feeds = [
      { url: "https://www.barandbench.com/feed" },
      { url: "https://www.livelaw.in/rss/law" },
      { url: "https://www.scconline.com/blog/post/category/news/feed/" },
      { url: "https://indialegallive.com/feed/" },
      { url: "https://lawbeat.in/rss.xml" },
      { url: "https://www.latestlaws.com/feed/" }
    ];
    const rss2json = (url) =>
      `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}`;
    let allNews = [];
    let currentSearch = "";

    function setStatus(msg) {
      document.getElementById("statusMsg").textContent = msg || "";
    }
    function cleanDesc(desc) {
      if (!desc) return "";
      const text = desc.replace(/<[^>]+>/g, "").replace(/\s+/g, " ").trim();
      return text.length > 180 ? text.slice(0, 180) + "..." : text;
    }
    function getImg(item) {
      return item.thumbnail || (item.enclosure && item.enclosure.link) || "";
    }
    // Only this week's news
    function getWeekStories(news) {
      const now = new Date();
      const sevenDaysAgo = new Date(now);
      sevenDaysAgo.setDate(now.getDate() - 6);
      const startDate = new Date(sevenDaysAgo.getFullYear(), sevenDaysAgo.getMonth(), sevenDaysAgo.getDate());
      const endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
      return news.filter((item) => {
        if (!item.pubdate) return false;
        const d = new Date(item.pubdate);
        return d >= startDate && d < endDate;
      });
    }
    function formatPubDate(pubdate) {
      if (!pubdate) return "";
      let d = new Date(pubdate);
      return d.toLocaleString();
    }
    // TOP STORY: Colorful card, badge, big font, arrow nav, auto "Featured" if property present
    function renderTopCarousel(topStories) {
      const container = document.getElementById("top-carousel");
      if (!topStories || !topStories.length) {
        container.innerHTML = "";
        return;
      }
      // Show only Supreme Court news or anything with 'featured: true'
      let weekSupreme = topStories.filter(n=>
        ((n.featured && n.featured===true) || ((n.title||"").toLowerCase().includes("supreme court")))
      );
      if(weekSupreme.length===0) weekSupreme = topStories;
      let slideIdx = 0;
      function getImgOrPlaceholder(story) {
        if(story.thumbnail || (story.enclosure && story.enclosure.link)) {
          return `<img class="top-story-img" src="${getImg(story)}" alt="Top story image" />`;
        }
        return `<div class="top-story-placeholder">No Image<br>Available</div>`;
      }
      function showSlide(n) {
        const story = weekSupreme[n];
        container.innerHTML = `
          <div class="top-story-highlight">
            ${story.featured?'<div class="top-story-featured-badge">Featured</div>':''}
            <div class="top-story-ribbon">WEEK'S TOP STORY</div>
            <button class="top-story-arrow left" id="prevSlide">&#8592;</button>
            ${getImgOrPlaceholder(story)}
            <div class="top-story-content">
              <span class="top-story-meta">
                ${(story.title||'').toLowerCase().includes('supreme court') ? "Supreme Court" : "Top News"} • ${formatPubDate(story.pubdate)}
              </span>
              <div class="top-story-title">${story.title}</div>
              <div class="top-story-snippet">${cleanDesc(story.description || story.content || "")}</div>
              <a class="top-story-link" href="${story.link}" target="_blank">Read More &rarr;</a>
            </div>
            <button class="top-story-arrow right" id="nextSlide">&#8594;</button>
          </div>
        `;
        document.getElementById("prevSlide").onclick = () => {
          slideIdx = (slideIdx - 1 + weekSupreme.length) % weekSupreme.length;
          showSlide(slideIdx);
        };
        document.getElementById("nextSlide").onclick = () => {
          slideIdx = (slideIdx + 1) % weekSupreme.length;
          showSlide(slideIdx);
        };
      }
      showSlide(slideIdx);
    }
    function renderGroupedNews(news) {
      let articles = [], supreme_court_cases = [], high_court_cases = [];
      news.forEach((item) => {
        const h = (item.title || "").toLowerCase();
        if (h.includes("supreme court")) {
          supreme_court_cases.push(item);
        } else if (h.includes("high court") || h.includes("hc")) {
          high_court_cases.push(item);
        } else {
          articles.push(item);
        }
      });
      function renderSection(title, group) {
        if (!group.length) return "";
        let html = `<h2>${title}</h2>`;
        group.forEach((item) => {
          const img = getImg(item);
          html += `<div class="news-card">
            ${img ? `<img class="news-img" src="${img}" loading="lazy" alt="news photo">` : ""}
            <div class="news-content">
              <a href="${item.link}" target="_blank">${item.title}</a>
              <div style="font-size:0.85em; color:#666;">${formatPubDate(item.pubdate)}</div>
              <div class="desc">${cleanDesc(item.description || item.content || "")}</div>
            </div>
          </div>`;
        });
        return html;
      }
      let html =
        renderSection("Supreme Court Cases", supreme_court_cases) +
        renderSection("High Court Cases", high_court_cases) +
        renderSection("Other Articles", articles);
      if (!html.trim()) html = "<p>No news found for your search.</p>";
      document.getElementById("law-news").innerHTML = html;
    }
    function renderApp() {
      let topNews = getWeekStories(allNews);
      renderTopCarousel(topNews);
      let filtered = getWeekStories(allNews);
      if(currentSearch) {
        if(/^\d{4}-\d{2}-\d{2}$/.test(currentSearch)) {
          filtered = filtered.filter((item) => {
            if (!item.pubdate) return false;
            const d = new Date(item.pubdate);
            const ymd = d.toISOString().split("T")[0];
            return ymd === currentSearch;
          });
        } else {
          const q = currentSearch.toLowerCase();
          filtered = filtered.filter(
            (item) =>
              (item.title && item.title.toLowerCase().includes(q)) ||
              (item.description && item.description.toLowerCase().includes(q))
          );
        }
      }
      renderGroupedNews(filtered);
      setStatus("");
    }
    async function getAllNews() {
      setStatus("Loading archive...");
      let { data: news, error } = await supabase
        .from("news").select("*")
        .order("pubdate", { ascending: false }).limit(300);
      if (error) {
        setStatus("Supabase error: " + error.message);
        news = [];
      } else if (!news) {
        setStatus("No news found in database.");
        news = [];
      }
      allNews = news;
      renderApp();
    }
    async function insertLatestNews(newsArray) {
      for (const item of newsArray) {
        let { data: existing } = await supabase
          .from("news").select("id")
          .eq("link", item.link).maybeSingle();
        if (!existing) {
          let { error } = await supabase.from("news").insert([item]);
          if (error) setStatus("Insert error: " + error.message);
        }
      }
    }
    async function fetchAndStoreNews() {
      setStatus("Fetching latest news feeds...");
      try {
        const results = await Promise.all(
          feeds.map((feed) =>
            fetch(rss2json(feed.url))
              .then((res) => res.json())
              .then((data) =>
                (data.items || []).map((item) => ({
                  title: item.title,
                  link: item.link,
                  description: item.description || item.content || "",
                  pubdate: item.pubDate || null,
                  thumbnail: item.thumbnail || "",
                  enclosure: item.enclosure || null,
                  featured: item.featured || false // you may set this in custom parse or admin
                }))
              )
              .catch(() => [])
          )
        );
        const freshNews = results.flat();
        await insertLatestNews(freshNews);
        await getAllNews();
      } catch (e) {
        setStatus("Failed news fetch: " + e);
        document.getElementById("law-news").innerHTML = "Failed: " + e;
      }
    }
    getAllNews();
    fetchAndStoreNews();
    setInterval(fetchAndStoreNews, 300000);
    document.getElementById("searchBar").addEventListener("input", function () {
      currentSearch = this.value.trim().toLowerCase();
      renderApp();
    });
  </script>
</body>
</html>

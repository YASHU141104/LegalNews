<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LegalNewsIndia - Law News</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { background: #f4f7fa; font-family: 'Roboto', Arial, sans-serif; margin: 0; padding: 2em 10vw; color: #111; }
    .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1em; }
    .logo { font-size: 2.3em; background: #244e86; color: #fff; border-radius: 50%; width: 2em; height: 2em; display: inline-flex; align-items: center; justify-content: center; }
    .sitename { font-size: 1.7em; font-weight: 700; color: #244e86;}
    .toggle-dark { background:#222; color:#fff; border:none; padding:8px 15px; border-radius:7px; cursor:pointer; font-size:1em;}
    .dark-mode { background: #222; color: #e2e2e2; }
    #statusMsg { color: #b00; margin-bottom: 1em; text-align: center; font-size: 1.07em; }
    #top-carousel { margin-bottom: 2em; }
    #searchBar { width: 340px; padding: 1em; font-size: 1.05em; border: 2px solid #4670ab; border-radius: 8px; box-shadow: 0 2px 14px #00336615; margin-bottom: 2em; display: block; margin-left: auto; margin-right: auto; }
    #law-news { max-width: 850px; margin-left: auto; margin-right: auto; }
    .news-card { background: white; box-shadow: 0 2px 12px #244e8620; border-radius: 12px; padding: 1.2em; margin-bottom: 1.3em; display: flex; flex-direction: row; align-items: flex-start; gap: 1.3em; }
    .news-img { width: 90px; height: 90px; object-fit: cover; border-radius: 8px; border: 1px solid #eee; background: #f6f9fc; flex-shrink: 0; }
    .news-content { flex: 1; }
    .news-content a { color: #1155cc; font-weight: 600; text-decoration: underline; font-size: 1.17em; }
    .desc { color: #202020; font-size: 0.98em; margin-top: 0.23em; margin-bottom: 0.8em; line-height: 1.6; }
    .court-header { color: #1D245D; font-weight:700; margin-top:1.3em; }
    .opportunity { margin:22px 1px; font-size:1.1em;}
    .top-story-slide { background: #fff; border-radius: 1.7em; box-shadow: 0 2px 20px #00336622; padding: 1.2em 1.3em 1em 1.3em; display: flex; align-items: center; gap: 2em; max-width: 860px; }
    @media (max-width: 700px) {
      body { padding: 1em 0.2em;}
      .news-card { flex-direction: column; align-items: flex-start;}
      .news-img { width: 100%; height: 150px;}
      .top-story-slide { flex-direction: column; gap: 0.7em;}
      .top-story-slide img { width: 100% !important; height: 160px !important;}
    }
  </style>
</head>
<body>
  <div class="header">
    <div>
      <span class="logo">‚öñÔ∏è</span>
      <span class="sitename">LegalNewsIndia</span>
    </div>
    <button class="toggle-dark" onclick="toggleDarkMode()">üåô Toggle Dark Mode</button>
  </div>

  <div id="statusMsg"></div>
  <div id="top-carousel"></div>
  <input type="text" id="searchBar" placeholder="Search news by keywords or date (YYYY-MM-DD)..." autocomplete="off" />
  <div id="law-news">Loading news...</div>
  <div id="opp-hub">
    <h2 class="court-header" style="margin-bottom:0.8em;margin-top:2em;">Opportunity Hub</h2>
    <div class="opportunity">
      <a href="https://lawbhoomi.com" target="_blank">LawBhoomi: Internships, Calls for Papers, Competitions</a>
    </div>
    <div class="opportunity">
      <a href="https://lawctopus.com" target="_blank">Lawctopus: Law School Opportunities & Resources</a>
    </div>
  </div>
  <script>
    // ========== CONFIG ==========
    const supabase_url = "https://xddssiompemprjbnxxlf.supabase.co";
    const supabase_key = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkZHNzaW9tcGVtcHJqYm54eGxmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMDczNzcsImV4cCI6MjA3Mzc4MzM3N30.QHjF8xdFYp6ex1YW2XV6GkKvPZXNp1biImoQIZdSMG4";
    const supabase = window.supabase.createClient(supabase_url, supabase_key);

    // List of India's 25 High Courts for grouping
    const highCourtsList = [
      "Allahabad", "Andhra Pradesh", "Bombay", "Calcutta", "Chhattisgarh", "Delhi",
      "Gauhati", "Gujarat", "Himachal Pradesh", "Jammu & Kashmir and Ladakh", "Jharkhand", "Karnataka", "Kerala",
      "Madhya Pradesh", "Madras", "Manipur", "Meghalaya", "Orissa", "Patna",
      "Punjab & Haryana", "Rajasthan", "Sikkim", "Telangana", "Tripura", "Uttarakhand"
    ];
    // ========== HELPERS ==========
    function setStatus(msg) { document.getElementById("statusMsg").textContent = msg || ""; }
    function cleanDesc(desc) {
      if (!desc) return "";
      const text = desc.replace(/<[^>]+>/g, "").replace(/\s+/g, " ").trim();
      return text.length > 180 ? text.slice(0, 180) + "..." : text;
    }
    function getImg(item) { return item.thumbnail || (item.enclosure && item.enclosure.link) || ""; }
    function formatPubDate(pubdate) {
      if (!pubdate) return ""; let d = new Date(pubdate); return d.toLocaleString();
    }
    function getWeekStories(news) {
      const now = new Date();
      const sevenDaysAgo = new Date(now);
      sevenDaysAgo.setDate(now.getDate() - 6);
      const startDate = new Date(sevenDaysAgo.getFullYear(), sevenDaysAgo.getMonth(), sevenDaysAgo.getDate());
      const endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
      return news.filter((item) => {
        if (!item.pubdate) return false;
        const d = new Date(item.pubdate);
        return d >= startDate && d < endDate;
      });
    }
    function isDateQuery(str) { return /^\d{4}-\d{2}-\d{2}$/.test(str); }

    // ========== CAROUSEL ==========
    function renderTopCarousel(topStories) {
      const container = document.getElementById("top-carousel");
      if (!topStories || !topStories.length) { container.innerHTML = ""; return; }
      let slideIdx = 0;
      function showSlide(n) {
        const story = topStories[n];
        let img = getImg(story);
        container.innerHTML = `
          <div class="top-story-slide">
            ${img ? `<img src="${img}" style="width:120px;height:120px;object-fit:cover;border-radius:1em;border:1.7px solid #eee;flex-shrink:0;">` : ""}
            <div style="flex:1">
              <div style="color:#B30348; font-weight:700; font-size:1.14em;margin-bottom:0.17em;">This Week's Top Story</div>
              <a href="${story.link}" target="_blank" style="color:#244e86;font-size:1.3em;font-weight:700;text-decoration:underline;display:block;">
                ${story.title}
              </a>
              <div style="font-size:0.85em; color:#666;">${formatPubDate(story.pubdate)}</div>
              <div style="color:#212121;font-size:1.04em;margin-top:0.25em;">
                ${cleanDesc(story.description || story.content || "")}
              </div>
            </div>
          </div>
        `;
      }
      showSlide(slideIdx);
      if (topStories.length > 1) {
        setInterval(() => { slideIdx = (slideIdx + 1) % topStories.length; showSlide(slideIdx); }, 6000);
      }
    }

    // ========== NEWS GROUPING ==========
    function renderGroupedNews(news) {
      let articles = [], supreme_court_cases = [], high_court_cases = [];
      news.forEach((item) => {
        const h = (item.title || "").toLowerCase();
        if (h.includes("supreme court")) supreme_court_cases.push(item);
        else if (h.includes("high court") || h.includes("hc")) high_court_cases.push(item);
        else articles.push(item);
      });

      // Sub-group High Courts by court
      let hcGroups = {};
      for (const court of highCourtsList) hcGroups[court] = [];
      high_court_cases.forEach(item => {
        const t = (item.title || "").toLowerCase();
        let matched = false;
        for (const court of highCourtsList) {
          if (t.includes(court.toLowerCase())) {
            hcGroups[court].push(item); matched = true; break;
          }
        }
        if (!matched) { if (!hcGroups["Other"]) hcGroups["Other"] = []; hcGroups["Other"].push(item);}
      });

      // Render sections
      function renderSection(title, group) {
        if (!group.length) return "";
        let html = `<h2 class="court-header">${title}</h2>`;
        group.forEach((item) => {
          const img = getImg(item);
          html += `<div class="news-card">
            ${img ? `<img class="news-img" src="${img}" loading="lazy" alt="news photo">` : ""}
            <div class="news-content">
              <a href="${item.link}" target="_blank">${item.title}</a>
              <div style="font-size:0.85em; color:#666;">${formatPubDate(item.pubdate)}</div>
              <div class="desc">${cleanDesc(item.description || item.content || "")}</div>
            </div>
          </div>`;
        });
        return html;
      }

      let html = renderSection("Supreme Court Cases", supreme_court_cases);
      // High Courts, each as a group
      let hcHtml = "";
      for (const court of highCourtsList) {
        if (hcGroups[court]?.length) hcHtml += renderSection(`${court} High Court`, hcGroups[court]);
      }
      if (hcGroups["Other"]?.length)
        hcHtml += renderSection("Other High Courts", hcGroups["Other"]);
      if (hcHtml) html += `<h2 class="court-header">High Court Cases</h2>${hcHtml}`;
      html += renderSection("Other Articles", articles);

      if (!html.trim()) html = "<p>No news found for your search.</p>";
      document.getElementById("law-news").innerHTML = html;
    }

    // ========== NEWS LOADING ==========
    let allNews = [];
    async function getAllNews() {
      setStatus("Loading archive...");
      let { data: news, error } = await supabase
        .from("news")
        .select("*")
        .order("pubdate", { ascending: false })
        .limit(300);
      if (error) { setStatus("Supabase error: " + error.message); news = []; }
      else if (!news) { setStatus("No news found in database."); news = []; }
      allNews = news;
      const weekNews = getWeekStories(allNews).sort((a, b) => new Date(b.pubdate) - new Date(a.pubdate));
      renderTopCarousel(weekNews.slice(0, 4)); // Top 4 this week
      renderGroupedNews(weekNews);
      setStatus(""); // Clear status
    }
    getAllNews();
    setInterval(getAllNews, 5*60*1000); // Refresh every 5min

    // ========== SEARCH ==========
    document.getElementById("searchBar").addEventListener("input", function () {
      const q = this.value.trim().toLowerCase();
      if (!q) {
        const weekNews = getWeekStories(allNews).sort((a, b) => new Date(b.pubdate) - new Date(a.pubdate));
        renderTopCarousel(weekNews.slice(0, 4));
        renderGroupedNews(weekNews);
        setStatus("");
        return;
      }
      let filtered = [];
      if (isDateQuery(q)) {
        filtered = allNews.filter((item) => {
          if (!item.pubdate) return false;
          const d = new Date(item.pubdate);
          const ymd = d.toISOString().split("T")[0];
          return ymd === q;
        });
      } else {
        filtered = allNews.filter(
          (item) =>
            (item.title && item.title.toLowerCase().includes(q)) ||
            (item.description && item.description.toLowerCase().includes(q))
        );
      }
      filtered.sort((a, b) => new Date(b.pubdate) - new Date(a.pubdate));
      renderTopCarousel([]); // Hide carousel when searching
      renderGroupedNews(filtered);
      setStatus(filtered.length ? "" : "No news found for your search.");
    });

    // ========== DARK MODE ==========
    function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
  </script>
</body>
</html>
